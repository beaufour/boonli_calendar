<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Boonli Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
</head>

<body>

    <div class="col-lg-8 mx-auto p-4 py-md-5">
        <header class="d-flex align-items-center pb-3 mb-5 border-bottom">
            <span class="fs-4">Boonli Calendar</span>
        </header>

        <main>
            <p class="fs-5 col-md-8">
                Enter your login details to Boonli below here to generate a URL for your iCalendar.
            </p>

            <p class="fs-5 col-md-8">
                Since Boonli does not have an API, we sadly need your password. We will not store your login information
                anywhere! We wil encrypt the information in the URL. The key is stored securely in Google Cloud.
            </p>

            <form class="fs-5 col-md-8 needs-validation" onsubmit="handleSubmit(event, this)">
                <div class="mb-3">
                    <label for="inputCustomerId" class="form-label">Customer ID</label>
                    <input class="form-control" id="inputCustomerId" name="customer_id" required>
                </div>
                <div class="mb-3">
                    <label for="inputEmail" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="inputEmail" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="inputPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="inputPassword" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>

            <div id="alert" class="alert alert-danger" style="margin-top: 25px; display: none" role="alert">
            </div>

            <div class="fs-5 col-md-8 mt-5">
                Calendar URL:
                <input id="calendarUrl" type="text" class="form-control" readonly="true" />
            </div>

            <div class="fs-5 col-md-8 mt-5">
                Note that Google Calendar has some kind of bug where it won't let you add the url. I'm unsure about
                why, but if you shorten the url through a url shortener like <a href="http://bitly.com/">Bitly</a>
                it'll work.
            </div>

            <div class="fs-5 col-md-8 mt-5">
                <div id="spinner" style="display: none">
                    Loading calendar data
                    <div id="spinner" class="spinner-border text-info" role="status">
                    </div>
                </div>
                <pre id="output" style="display: none"></pre>
            </div>

            <footer class="pt-5 my-5 text-muted border-top">
                See <a href="https://github.com/beaufour/boonli_calendar">here</a> for more information about this
                project.
            </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
        integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz"
        crossorigin="anonymous"></script>

    <script type="text/javascript">
        "use strict";

        var api_location = new URL(location.href);
        if (!location.href.startsWith("http://localhost")) {
            api_location.host = "api." + api_location.host;
        }

        function clear_alert() {
            var elem = document.getElementById("alert");
            elem.style.display = "none";
        }

        function display_alert(message) {
            console.error("Alert:", message);
            var elem = document.getElementById("alert");
            elem.style.display = "block";
            elem.textContent = message
        }

        async function handleErrors(response) {
            if (!response.ok) {
                throw Error(await response.text());
            }
            return response;
        }

        function showCalendar(url) {
            var spinner = document.getElementById("spinner")
            var output = document.getElementById("output");

            output.style.display = "none";
            spinner.style.display = "block";
            url.searchParams.set("fmt", "json");
            fetch(url).then(handleErrors)
                .then((response) => response.json())
                .then((data => {
                    var text = "";
                    for (const menu of data) {
                        text += menu["day"] + " " + menu["menu"] + "\n";
                    }
                    output.textContent = text;
                    output.style.display = "block";
                    spinner.style.display = "none";
                })).catch((error) => {
                    output.textContent = error;
                    output.style.display = "block";
                    spinner.style.display = "none";
                    console.error("error showing calendar:", error);
                });
        }

        function handleSubmit(event, form) {
            event.preventDefault();

            var input = document.getElementById("calendarUrl");
            input.value = "";

            var data = new FormData(form);
            fetch(new URL("/encrypt/", api_location), { method: "post", body: data }).then((response) => response.json())
                .then((data) => {
                    if ("error" in data) {
                        display_alert(data["error"]["message"]);
                        return;
                    }

                    clear_alert();
                    var eid = data["eid"];
                    var url = new URL("/calendar/", api_location);
                    url.search = new URLSearchParams(
                        { eid: data["eid"] }
                    )

                    input.value = url.toString();
                    input.focus()
                    input.select();

                    showCalendar(url);
                })
                .catch((error) => {
                    display_alert("Error on API call: " + error);
                });
        }
    </script>
</body>

</html>
