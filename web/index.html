<!doctype html>
<html lang="en">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FXJ2FE1WW1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FXJ2FE1WW1');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Boonli Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <style type="text/css">
        [v-cloak] {
            display: none;
        }

    </style>
</head>

<body>

    <div class="col-lg-8 mx-auto p-4 py-md-5">
        <header class="d-flex align-items-center pb-3 mb-5 border-bottom">
            <span class="fs-4">Boonli Calendar</span>
        </header>

        <main>
            <p class="fs-5 col-md-8">
                Enter your login details to Boonli below here to generate a URL for your calendar.
            </p>

            <p class="fs-5 col-md-8">
                Since Boonli does not have an API, we sadly need your password. We will not store your login information
                anywhere! We wil encrypt your login information directly in the URL, so it will not be stored on any of
                our servers. The encryption key is stored securely in Google Cloud.
            </p>

            <form class="fs-5 col-md-8 needs-validation" @submit.prevent="handleSubmit">
                <div class="mb-3">
                    <label for="inputCustomerId" class="form-label">Customer ID</label>
                    <input class="form-control" id="inputCustomerId" name="customer_id" required
                        aria-describedby="customerIdHelpBlock">
                    <div id="customerIdHelpBlock" class="form-text">
                        This is the first part of the URL where you log in to Boonli. Like if you use
                        <b>https://lunar.boonli.com/</b> to log in, you should fill in
                        <b>lunar</b> here.
                    </div>
                </div>
                <div class="mb-3">
                    <label for="inputEmail" class="form-label">Username</label>
                    <input type="email" class="form-control" id="inputEmail" name="username" required
                        aria-describedby="emailIdHelpBlock">
                    <div id="emailIdHelpBlock" class="form-text">
                        This is usually your email address.
                    </div>
                </div>
                <div class="mb-3">
                    <label for="inputPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="inputPassword" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>

            <div v-cloak v-if="alert" class="alert alert-danger" style="margin-top: 25px;" role="alert"> {{ alert }}
            </div>

            <div class="fs-5 col-md-8 mt-5">
                Calendar URL:
                <input v-model="calendarUrl" id="calendarUrl" type="text" class="form-control" readonly="true" />
            </div>

            <div class="fs-5 col-md-8 mt-5">
                Take the above URL and subscribe to it in your preferred calendar application. In Google
                Calendar it's under <i>Other Calendars, +, From URL</i>. In Apple Calendar it's under <i>File, New
                    Calendar
                    Subscription</i>.
            </div>

            <div class="fs-5 col-md-8 mt-5">
                Note that Google Calendar has some kind of bug where it won't let you add the url. I'm unsure about
                why, but if you shorten the url through a url shortener like <a href="http://bitly.com/">Bitly</a>
                it'll work.
            </div>

            <div class="fs-5 col-md-8 mt-5">
                <div v-cloak v-if="loading">
                    Loading calendar data
                    <div id="spinner" class="spinner-border text-info" role="status">
                    </div>
                </div>
                <pre v-cloak v-if="output">{{ output }}</pre>
            </div>
        </main>

        <footer class="pt-5 my-5 text-muted border-top">
            See <a href="https://github.com/beaufour/boonli_calendar">here</a> for more information about this project.
            You can also contact us at <a href="mailto:boonli_calendar@vovhund.com">boonli_calendar@vovhund.com</a>
        </footer>

    </div>

    <script src="https://browser.sentry-cdn.com/7.16.0/bundle.tracing.min.js"
        integrity="sha384-wXU9CL14HxNQidSEdsPNgsvTyYYWogbqur94ac59B5M+zWrBqgC7NRLzv1AHdz0j"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
        integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz"
        crossorigin="anonymous"></script>

    <script type="module">
        "use strict";

        import { createApp } from 'https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.es.js'

        var api_location = new URL(location.href);
        if (!location.href.startsWith("http://localhost")) {
            api_location.host = "api." + api_location.host;
        }

        async function handleErrors(response) {
            if (!response.ok) {
                throw Error(await response.text());
            }
            return response;
        }

        createApp({
            alert: "",
            setAlert: function (message) {
                if (message) {
                    console.error("Alert:", message);
                }
                this.alert = message;
            },
            loading: false,
            output: "",
            calendarUrl: "",

            showCalendar: function (url) {
                this.loading = true;
                this.output = "";

                url.searchParams.set("fmt", "json");
                fetch(url).then(handleErrors)
                    .then((response) => response.json())
                    .then((data => {
                        var text = "";
                        for (const menu of data) {
                            text += menu["day"] + " " + menu["menu"] + "\n";
                        }
                        this.output = text;
                        this.loading = false;
                    })).catch((error) => {
                        this.output = error.toString();
                        this.loading = false;
                        console.error("error showing calendar:", error);
                    });
            },

            handleSubmit: function (event) {
                this.calendarUrl = "";
                this.output = "";
                this.setAlert("");

                var data = new FormData(event.target);
                fetch(new URL("/encrypt/", api_location), { method: "post", body: data }).then((response) => response.json())
                    .then((data) => {
                        if ("error" in data) {
                            this.setAlert(data["error"]["message"]);
                            return;
                        }

                        var eid = data["eid"];
                        var url = new URL("/calendar/", api_location);
                        url.search = new URLSearchParams(
                            { eid: data["eid"] }
                        )

                        this.calendarUrl = url.toString();
                        var input = document.getElementById("calendarUrl");
                        input.focus()
                        input.select();

                        this.showCalendar(url);
                    })
                    .catch((error) => {
                        this.setAlert("Error on API call: " + error);
                    });
            },
        }).mount()
    </script>

    <script type="text/javascript">
        Sentry.init({
            dsn: "https://a9f806daa30041ae8018aea37c41a48e@o1366758.ingest.sentry.io/4504023579295744",
            integrations: [new Sentry.BrowserTracing()],
            tracesSampleRate: 1.0,
        });
    </script>
</body>

</html>
